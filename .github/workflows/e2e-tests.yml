name: End-to-End Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - user-journey
          - load
          - disaster-recovery

jobs:
  user-journey-tests:
    name: User Journey Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'user-journey' || github.event.inputs.test_suite == '' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: e2e-tests/user-journey-tests/package-lock.json

      - name: Start services
        run: |
          docker-compose up -d
          echo "Waiting for services to be healthy..."
          sleep 60

      - name: Check service health
        run: |
          for port in 8091 8092 8093 8094 8095; do
            echo "Checking service on port $port..."
            curl -f http://localhost:$port/actuator/health || exit 1
          done

      - name: Install dependencies
        working-directory: e2e-tests/user-journey-tests
        run: npm ci

      - name: Run user journey tests
        working-directory: e2e-tests/user-journey-tests
        run: npm test

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: user-journey-reports
          path: e2e-tests/user-journey-tests/reports/

      - name: Stop services
        if: always()
        run: docker-compose down -v

  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'load' || github.event_name == 'schedule' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: e2e-tests/load-tests/requirements.txt

      - name: Start services
        run: |
          docker-compose up -d
          echo "Waiting for services to be healthy..."
          sleep 60

      - name: Check service health
        run: |
          for port in 8091 8092 8093 8094 8095; do
            echo "Checking service on port $port..."
            curl -f http://localhost:$port/actuator/health || exit 1
          done

      - name: Install dependencies
        working-directory: e2e-tests/load-tests
        run: pip install -r requirements.txt

      - name: Run load tests
        working-directory: e2e-tests/load-tests
        run: |
          locust -f locustfile.py \
            --headless \
            --users 100 \
            --spawn-rate 10 \
            --run-time 5m \
            --host http://localhost:8091 \
            --html ../reports/load-test-report.html \
            --csv ../reports/load-test

      - name: Upload load test reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: load-test-reports
          path: e2e-tests/reports/

      - name: Check performance thresholds
        run: |
          # Parse CSV and check if average response time is under 3 seconds
          avg_response=$(awk -F',' 'NR>1 {sum+=$6; count++} END {print sum/count}' e2e-tests/reports/load-test_stats.csv)
          echo "Average response time: ${avg_response}ms"
          if (( $(echo "$avg_response > 3000" | bc -l) )); then
            echo "❌ Performance threshold exceeded!"
            exit 1
          fi
          echo "✅ Performance within acceptable limits"

      - name: Stop services
        if: always()
        run: docker-compose down -v

  disaster-recovery-tests:
    name: Disaster Recovery Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'disaster-recovery' || github.event_name == 'schedule' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Start services
        run: |
          docker-compose up -d
          echo "Waiting for services to be healthy..."
          sleep 60

      - name: Run disaster recovery tests
        working-directory: e2e-tests/disaster-recovery-tests
        run: mvn clean test

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: disaster-recovery-reports
          path: e2e-tests/disaster-recovery-tests/target/surefire-reports/

      - name: Stop services
        if: always()
        run: docker-compose down -v

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [user-journey-tests, load-tests, disaster-recovery-tests]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate summary
        run: |
          echo "# E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.user-journey-tests.result }}" == "success" ]; then
            echo "✅ User Journey Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ User Journey Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.load-tests.result }}" == "success" ]; then
            echo "✅ Load Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Load Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.disaster-recovery-tests.result }}" == "success" ]; then
            echo "✅ Disaster Recovery Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Disaster Recovery Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Test reports are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          if [ "${{ needs.user-journey-tests.result }}" != "success" ] || \
             [ "${{ needs.load-tests.result }}" != "success" ] || \
             [ "${{ needs.disaster-recovery-tests.result }}" != "success" ]; then
            echo "Some E2E tests failed"
            exit 1
          fi
          echo "All E2E tests passed successfully!"
